# Jarvis Bot

A Discord bot to upload images generated by self-hosted ComfyUI. Additionally send prompts to self-hosted Ollama instance for modification.

Not designed for high volume, no queuing or rate-limiting in place.

## Requirements

* ComfyUI instance
* Ollama instance
* Python 3.x
* Python venv module
* Discord Dev account and bot configured

### Discord Bot

Bot permissions needed:

* Message content intent:
    * Text: Send Messages
    * Text: Attach Files
    * Text: Create Polls

## Setup

1. Clone to dir and run setup script: `setup.sh`
2. Create dir `jarvis` in the `models/checkpoints` directory in ComfyUI.
3. Create symlinks in the `jarvis` directory for your models:
```bash
cd /opt/ComfyUI/models/checkpoints
ln -sr sdxl/sdx_model.safetensors jarvis/
```
4. Modify `jarvis.conf` to setup bot token, Ollama settings, and ComfyUI settings.
5. Modify `system.txt` for Ollama system prompt.

## Running

Start by activating venv and running `bot.py`.

```bash
source venv/bin/activate
python3 bot.py
```

## Bot Commands

* !jarvis <positive>|<negative>
    * Sends prompt straight to ComfyUI for processing
    * Negative is optional, pipe "|" delimiter
* !prompt <text>
    * Sends text to Ollama for processing then ComfyUI
    * Does not process negatives yet (after pipe "|")
* !checkpoint
    * Shows current configured ComfyUI checkpoint
* !count
    * Shows the current number of files in `./images`
* !poll
    * Start a poll to vote on checkpoint used for generation
* !wc
    * Generates a word cloud based on all text in `./prompts`
* !reload
    * Only accesable by bot owner
    * Reloads Cogs: `./cogs/*.py`

## ComfyUI

Dummy node from KJNodes is used for the "Load Workflow" process. Import `load_workflow.json` into ComfyUI to install missing nodes.

## Workflows

The workflow provided is the default workflow in ComfyUI, last node changed to the node "SaveImageWebsocket". Edit `workflow.json` to change the steps, cfg, sampler, and other settings.

The `load_model.json` workflow is the exact same except a dummy out. ComfyUI-KJNodes extension needed.

For custom workflows export as API with the name `workflow.json` and overwrite in folder. You'll need to modify the `generator.py` script `workflow` variables to the proper node numbers.

## Polls

Polls have to wait for embed message to come in with poll winner, then bot will change model. There can be a delay of multiple seconds from poll end until winning message arrives.

## Ollama

Test your Ollama settings with `test-prompt.py`

The baked in user prompt expects the output to be wrapped in triple quotes `"""`.
